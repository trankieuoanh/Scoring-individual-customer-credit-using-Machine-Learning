---
title: "Untitled"
author: "oanh"
date: "2025-04-27"
output: word_document
---

```{r}
library(Metrics)
library(tseries)
library(urca)
library(Hmisc)
library(forecast)
library(car)
library(tidyverse)
library(cowplot)
library(readxl)
library(vars)
library(ggplot2)
library(scales)
library(dplyr)
library(ROSE)
library(caret)
```

```{r}
DataCR <- read_excel("C:/Users/ADMIN/Downloads/credit_risk_dataset.xls")
View(DataCR)
attach(DataCR)
```

#1. Preprocessing data
```{r}
#1.1. Descriptive statistic
summary(DataCR)
```
```{r}
# 1.2: Xem biến trạng thái loan_status
table(DataCR$loan_status)
prop.table(table(DataCR$loan_status))
```
```{r}
#1.3: Xử lý dữ liệu missing 
colSums(is.na(DataCR))
```
```{r}
# Điền missing cho person_emp_length bằng median
median_emp_length <- median(DataCR$person_emp_length, na.rm = TRUE)
DataCR$person_emp_length[is.na(DataCR$person_emp_length)] <- median_emp_length

# Điền missing cho loan_int_rate bằng median
median_loan_int_rate <- median(DataCR$loan_int_rate, na.rm = TRUE)
DataCR$loan_int_rate[is.na(DataCR$loan_int_rate)] <- median_loan_int_rate

```

#2. Chọn biến từ bằng cách tính chỉ số IV của các biến trên tập train
```{r}
IV <- Information::create_infotables(data = DataCR, y = "loan_status", parallel = FALSE)
print(IV$Summary)
```
```{r}
# Loại bỏ các biế có IV<0.02
vars_removed <- IV$Summary %>% as.data.frame %>% 
                                    subset(IV < 0.02) %>% pull(1)
vars_removed
```
```{r}
# Tạo dữ liệu sau khi lọc biến 
data<- DataCR %>% dplyr::select(-all_of(vars_removed))
```

```{r}
#Chia tập dữ liệu train và test 
ind <- sample(2, nrow(data), replace = TRUE, prob = c(0.7, 0.3))
train.data <- data [ind == 1, ]
test.data<- data [ind == 2, ]
```

```{r}
library(scorecard)
# Bin các biến theo WOE
bins <- woebin(train.data, y = "loan_status")
woebin_plot(bins)
```

```{r}
# Chạy mô hình Logit - thực hiện trên tập trên 
train.data_woe <- woebin_ply(train.data, bins)
logit.model <- glm(loan_status ~., family = binomial(link = 'logit'), data = train.data_woe)
summary(logit.model)
```
#Các biến person_income_woe, person_home_ownership_woe, person_emp_length_woe, loan_intent_woe, loan_grade_woe, loan_amnt_woe, loan_int_rate_woe, và loan_percent_income_woe đều có ý nghĩa thống kê trong mô hình (p-value < 0.05).

#Trong đó, loan_intent_woe, loan_grade_woe, và loan_percent_income_woe là các biến có mức độ ảnh hưởng rất lớn, với hệ số ước lượng cao và p-value cực kỳ nhỏ (< 2e-16).

#Biến cb_person_default_on_file_woe (lịch sử vỡ nợ trước đây) có p-value = 0.176, không đạt ý nghĩa thống kê ở mức tin cậy 95%. Điều này cho thấy lịch sử vỡ nợ trong quá khứ không ảnh hưởng đáng kể đến khả năng vỡ nợ hiện tại trong tập dữ liệu này.

```{r}
# Lọc biến mô hình logic theo stepwise
logit.step <- step(logit.model, direction = "backward", trace = 0)
summary(logit.step)

```
#Validate mô hình - confusionMatrix trên tập train
```{r}
train.prob <- predict(logit.step, type = "response")
train.pred <- ifelse(train.prob > .5, "1", "0")
table.train<-table(train.pred, train.data$loan_status)
table.train
```
```{r}
confusionMatrix.train<-prop.table(table.train)
confusionMatrix.train
```
#Validate mô hình - confusionMatrix trên tập test
#Chuyển dữ liệu theo woe
```{r}
test.data_woe <- woebin_ply(test.data, bins)
head(test.data_woe)

```
#confusionMatrix
```{r}
test.pred.prob <- predict(logit.model, test.data_woe, type = 'response')
test.pred<- as.factor(ifelse(test.pred.prob > 0.5, 1, 0))
table.test<-table(test.pred, test.data$loan_status)
table.test
```
```{r}
confusionMatrix.test<-prop.table(table.test)
confusionMatrix.test
```
# Chỉ tiêu khác 
```{r}
sensitivity(factor(test.pred), factor(test.data$loan_status))
specificity(factor(test.pred), factor(test.data$loan_status))
# Misclassification Error = số lượng dự đoán sai / tổng số mẫu
mean(test.pred != test.data$loan_status)

```
# Vẽ đừờng cong ROC
```{r}
library(ROCR)
# Logistic Regression ROC curve
roc.pred <- prediction(predictions = test.pred.prob, labels = test.data$loan_status)
roc.perf <- performance(roc.pred, measure = "tpr", x.measure = "fpr")
# Tính chỉ số AUROC
AUROC_value <- roc.perf@y.values[[1]]
auc <- as.numeric(performance(roc.pred, measure = "auc")@y.values)
plot(roc.perf, main = "ROC Curve for credit risk Prediction Approaches", col = 2, lwd = 2)
abline(a = 0, b = 1, lwd = 3, lty = 2, col = 1)
```

```{r}
# Tính chỉ số AUROC và GINI
auc <- as.numeric(performance(roc.pred, measure = "auc")@y.values)
auc

gini <- 2*auc - 1
gini
```
# Thực hiện tính score
```{r}
# Calculate scorecard scores for variables based on the results from woebin and glm: 
my_card <- scorecard(bins, logit.model, points0 = 600, odds0 = 1/19, pdo = 50)
head(my_card)
```
#Show Results
```{r}
# Calculate scorecard scores
z_score<-log(train.prob/(1-train.prob))
head(z_score,10)
```
#scalling Factor & Offset
```{r}
credit_score <-100+2*z_score
hist(credit_score)
```
#Random Forest
```{r}
library(randomForest)
train.data_woe$loan_status <- as.factor(train.data_woe$loan_status)
test.data_woe$loan_status  <- as.factor(test.data_woe$loan_status)

rf_model <- randomForest(loan_status ~ ., 
                         data = train.data_woe, ntree = 100, 
                         mtry = sqrt(ncol(train.data_woe) - 1),  
                         importance = TRUE,proximity = TRUE)  
summary(rf_model)
```
```{r}
# Dự đoán kết quả trên tập kiểm tra
rf_pred_probs <- predict(rf_model, newdata = test.data_woe, type = "response")

# Dự đoán phân loại
rf_pred_class <- as.factor(rf_pred_probs)

# Tạo ma trận nhầm lẫn
conf_matrix_rf <- table(Predicted = rf_pred_class, Actual = test.data_woe$loan_status)
conf_matrix_rf
```
```{r}
accuracy_rf <- sum(diag(conf_matrix_rf)) / sum(conf_matrix_rf)
accuracy_rf

```
```{r}
precision_rf <- conf_matrix_rf[2, 2] / sum(conf_matrix_rf[, 2])
precision_rf

```

```{r}
recall_rf <- conf_matrix_rf[2, 2] / sum(conf_matrix_rf[2, ])
recall_rf
```

```{r}
f1_score_rf <- 2 * (precision_rf * recall_rf) / (precision_rf + recall_rf)
f1_score_rf
```

```{r}
library(pROC)
rf_pred_probs <- predict(rf_model, newdata = test.data_woe, type = "prob")[, 2]
roc_obj_rf <- roc(test.data_woe$loan_status, rf_pred_probs)
auc_value_rf <- auc(roc_obj_rf)
auc_value_rf
plot(roc_obj_rf, main = "ROC Curve - Random Forest")
```
# KNN
```{r}
library(tree)
tree_model <- tree(loan_status ~ ., 
                   data = train.data_woe,
                   control = tree.control(nobs = nrow(train.data_woe),
                   mincut = 10,minsize = 20,mindev = 0.01))
summary(tree_model)
```
```{r}
plot(tree_model)
text(tree_model, pretty = 0)
```
```{r}
pred_class <- predict(tree_model, newdata = test.data_woe, type = "class")
pred_class <- ifelse(pred_class == "1", 1, 0)
conf_matrix=table(Predicted = pred_class, Actual = test.data_woe$loan_status)
conf_matrix
```
```{r}
accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy
precision <- conf_matrix[2, 2] / sum(conf_matrix[, 2])
precision
recall <- conf_matrix[2, 2] / sum(conf_matrix[2, ])
recall
```
```{r}
pred_probs <- predict(tree_model, newdata = test.data_woe, type = "vector")[, 2]

roc_obj <- roc(test.data_woe$loan_status, pred_probs)
auc_value <- auc(roc_obj)
auc_value
plot(roc_obj, main = "ROC Curve - Decision Tree")
```
```{r}
# chỉnh sửa lại cây 
# Cross-validation
cv_tree <- cv.tree(tree_model, FUN = prune.misclass)
plot(cv_tree$size, cv_tree$dev, type = "b")  # Chọn kích thước cây tối ưu
# Cắt tỉa cây
pruned_tree <- prune.misclass(tree_model, best = 5)  # Chọn cây 5 nút
plot(pruned_tree)
text(pruned_tree, pretty = 0)
```



